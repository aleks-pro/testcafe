'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _isNan = require('babel-runtime/core-js/number/is-nan');

var _isNan2 = _interopRequireDefault(_isNan);

exports.default = function (configString) {
    if (!configCache[configString]) configCache[configString] = getNewConfig(configString);

    return configCache[configString];
};

var _chromeEmulatedDevicesList = require('chrome-emulated-devices-list');

var _chromeEmulatedDevicesList2 = _interopRequireDefault(_chromeEmulatedDevicesList);

var _lodash = require('lodash');

var _argumentParsing = require('../../../utils/argument-parsing');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const HEADLESS_DEFAULT_WIDTH = 1280;
const HEADLESS_DEFAULT_HEIGHT = 800;

const AVAILABLE_MODES = ['userProfile', 'headless', 'emulation'];

const configCache = {};

function parseUserArgs(userArgs) {
    const parsedArgs = {
        headless: false,
        userDataDir: false,
        windowSize: false
    };

    const splittedArgs = userArgs.split(' ').filter(arg => !!arg);

    splittedArgs.forEach(arg => {
        const keyValuePair = arg.split('=');
        const key = (0, _lodash.camelCase)(keyValuePair[0]);

        parsedArgs[key] = parsedArgs[key] !== void 0;
    });

    return parsedArgs;
}

function parseModes(modesStr, userArgs) {
    const parsed = (0, _argumentParsing.splitEscaped)(modesStr, ':');
    const path = (0, _argumentParsing.getPathFromParsedModes)(parsed, AVAILABLE_MODES);
    const detectedModes = (0, _argumentParsing.getModes)(parsed, AVAILABLE_MODES);
    let optionsString = '';

    if (parsed.length) optionsString = parsed.shift();

    while (parsed.length) optionsString += ':' + parsed.shift();

    const userProfile = detectedModes.userProfile || userArgs.userDataDir;
    const headless = detectedModes.headless || userArgs.headless;
    const emulation = detectedModes.emulation || headless;

    const modes = {
        path,
        userProfile,
        headless,
        emulation
    };

    return { modes, optionsString };
}

function simplifyDeviceName(deviceName) {
    return deviceName.replace(/\s/g, '').toLowerCase();
}

function findDevice(deviceName) {
    const simpleName = simplifyDeviceName(deviceName);

    return _chromeEmulatedDevicesList2.default.filter(device => simplifyDeviceName(device.title).indexOf(simpleName) >= 0)[0];
}

function getDeviceBasedOptions(deviceName, orientation) {
    if (!deviceName) return {};

    const deviceData = findDevice(deviceName);

    if (!deviceData) return {};

    const mobile = deviceData.capabilities.indexOf('mobile') >= 0;

    if (!orientation) orientation = mobile ? 'vertical' : 'horizontal';

    return {
        mobile: mobile,
        orientation: orientation,
        touch: deviceData.capabilities.indexOf('touch') >= 0,
        width: deviceData.screen[orientation].width,
        height: deviceData.screen[orientation].height,
        scaleFactor: deviceData.screen['device-pixel-ratio'],
        userAgent: deviceData['user-agent']
    };
}

function parseOptions(str, useDefaultDimensions) {
    const parsed = (0, _argumentParsing.splitEscaped)(str, ';');

    const baseOptions = {
        width: useDefaultDimensions ? HEADLESS_DEFAULT_WIDTH : 0,
        height: useDefaultDimensions ? HEADLESS_DEFAULT_HEIGHT : 0,
        scaleFactor: 0,
        mobile: false,
        cdpPort: (0, _argumentParsing.findMatch)(parsed, /^cdpPort=(.*)/)
    };

    const deviceName = (0, _argumentParsing.findMatch)(parsed, /^device=(.*)/);
    const orientation = (0, _argumentParsing.findMatch)(parsed, /^orientation=(.*)/);
    const deviceBasedOptions = getDeviceBasedOptions(deviceName, orientation);

    let specifiedDeviceOptions = {
        orientation: orientation,
        touch: (0, _argumentParsing.hasMatch)(parsed, /^touch=/) ? (0, _argumentParsing.isMatchTrue)(parsed, /^touch=(.*)/) : void 0,
        mobile: (0, _argumentParsing.isMatchTrue)(parsed, /^mobile=(.*)/),
        width: Number((0, _argumentParsing.findMatch)(parsed, /^width=(.*)/) || NaN),
        height: Number((0, _argumentParsing.findMatch)(parsed, /^height=(.*)/) || NaN),
        scaleFactor: Number((0, _argumentParsing.findMatch)(parsed, /^scaleFactor=(.*)/) || NaN),
        userAgent: (0, _argumentParsing.findMatch)(parsed, /^userAgent=(.*)/)
    };

    specifiedDeviceOptions = (0, _lodash.pickBy)(specifiedDeviceOptions, optionValue => {
        return optionValue !== void 0 && optionValue !== '' && !(0, _isNan2.default)(optionValue);
    });

    return (0, _assign2.default)(baseOptions, deviceBasedOptions, specifiedDeviceOptions);
}

function getNewConfig(configString) {
    var _parseConfig = (0, _argumentParsing.parseConfig)(configString);

    const userArgs = _parseConfig.userArgs,
          modesString = _parseConfig.modesString;

    const parsedUserArgs = parseUserArgs(userArgs);

    var _parseModes = parseModes(modesString, parsedUserArgs);

    const modes = _parseModes.modes,
          optionsString = _parseModes.optionsString;

    const useDefaultDimensions = modes.headless && !parsedUserArgs.windowSize;
    const options = parseOptions(optionsString, useDefaultDimensions);

    return (0, _assign2.default)({ userArgs }, modes, options);
}

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9jaHJvbWUvY29uZmlnLmpzIl0sIm5hbWVzIjpbImNvbmZpZ1N0cmluZyIsImNvbmZpZ0NhY2hlIiwiZ2V0TmV3Q29uZmlnIiwiSEVBRExFU1NfREVGQVVMVF9XSURUSCIsIkhFQURMRVNTX0RFRkFVTFRfSEVJR0hUIiwiQVZBSUxBQkxFX01PREVTIiwicGFyc2VVc2VyQXJncyIsInVzZXJBcmdzIiwicGFyc2VkQXJncyIsImhlYWRsZXNzIiwidXNlckRhdGFEaXIiLCJ3aW5kb3dTaXplIiwic3BsaXR0ZWRBcmdzIiwic3BsaXQiLCJmaWx0ZXIiLCJhcmciLCJmb3JFYWNoIiwia2V5VmFsdWVQYWlyIiwia2V5IiwicGFyc2VNb2RlcyIsIm1vZGVzU3RyIiwicGFyc2VkIiwicGF0aCIsImRldGVjdGVkTW9kZXMiLCJvcHRpb25zU3RyaW5nIiwibGVuZ3RoIiwic2hpZnQiLCJ1c2VyUHJvZmlsZSIsImVtdWxhdGlvbiIsIm1vZGVzIiwic2ltcGxpZnlEZXZpY2VOYW1lIiwiZGV2aWNlTmFtZSIsInJlcGxhY2UiLCJ0b0xvd2VyQ2FzZSIsImZpbmREZXZpY2UiLCJzaW1wbGVOYW1lIiwiZGV2aWNlIiwidGl0bGUiLCJpbmRleE9mIiwiZ2V0RGV2aWNlQmFzZWRPcHRpb25zIiwib3JpZW50YXRpb24iLCJkZXZpY2VEYXRhIiwibW9iaWxlIiwiY2FwYWJpbGl0aWVzIiwidG91Y2giLCJ3aWR0aCIsInNjcmVlbiIsImhlaWdodCIsInNjYWxlRmFjdG9yIiwidXNlckFnZW50IiwicGFyc2VPcHRpb25zIiwic3RyIiwidXNlRGVmYXVsdERpbWVuc2lvbnMiLCJiYXNlT3B0aW9ucyIsImNkcFBvcnQiLCJkZXZpY2VCYXNlZE9wdGlvbnMiLCJzcGVjaWZpZWREZXZpY2VPcHRpb25zIiwiTnVtYmVyIiwiTmFOIiwib3B0aW9uVmFsdWUiLCJtb2Rlc1N0cmluZyIsInBh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LGFBQWExQixhQUFiLEVBQTRCNEIsb0JBQTVCLENBQWxDOztBQUVBLFdBQU8sc0JBQWMsRUFBRTdDLFFBQUYsRUFBZCxFQUE0QnNCLEtBQTVCLEVBQW1DaUMsT0FBbkMsQ0FBUDtBQUNIIiwiZmlsZSI6ImJyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2Nocm9tZS9jb25maWcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZW11bGF0ZWREZXZpY2VzIGZyb20gJ2Nocm9tZS1lbXVsYXRlZC1kZXZpY2VzLWxpc3QnO1xuaW1wb3J0IHsgcGlja0J5IGFzIGZpbHRlclByb3BlcnRpZXMsIGNhbWVsQ2FzZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge1xuICAgIGhhc01hdGNoLCBmaW5kTWF0Y2gsIGlzTWF0Y2hUcnVlLCBnZXRNb2Rlcywgc3BsaXRFc2NhcGVkLCBnZXRQYXRoRnJvbVBhcnNlZE1vZGVzLCBwYXJzZUNvbmZpZ1xufSBmcm9tICcuLi8uLi8uLi91dGlscy9hcmd1bWVudC1wYXJzaW5nJztcblxuXG5jb25zdCBIRUFETEVTU19ERUZBVUxUX1dJRFRIICA9IDEyODA7XG5jb25zdCBIRUFETEVTU19ERUZBVUxUX0hFSUdIVCA9IDgwMDtcblxuY29uc3QgQVZBSUxBQkxFX01PREVTID0gWyd1c2VyUHJvZmlsZScsICdoZWFkbGVzcycsICdlbXVsYXRpb24nXTtcblxuY29uc3QgY29uZmlnQ2FjaGUgPSB7fTtcblxuZnVuY3Rpb24gcGFyc2VVc2VyQXJncyAodXNlckFyZ3MpIHtcbiAgICBjb25zdCBwYXJzZWRBcmdzID0ge1xuICAgICAgICBoZWFkbGVzczogICAgZmFsc2UsXG4gICAgICAgIHVzZXJEYXRhRGlyOiBmYWxzZSxcbiAgICAgICAgd2luZG93U2l6ZTogIGZhbHNlXG4gICAgfTtcblxuICAgIGNvbnN0IHNwbGl0dGVkQXJncyA9IHVzZXJBcmdzLnNwbGl0KCcgJykuZmlsdGVyKGFyZyA9PiAhIWFyZyk7XG5cbiAgICBzcGxpdHRlZEFyZ3MuZm9yRWFjaChhcmcgPT4ge1xuICAgICAgICBjb25zdCBrZXlWYWx1ZVBhaXIgPSBhcmcuc3BsaXQoJz0nKTtcbiAgICAgICAgY29uc3Qga2V5ICAgICAgICAgID0gY2FtZWxDYXNlKGtleVZhbHVlUGFpclswXSk7XG5cbiAgICAgICAgcGFyc2VkQXJnc1trZXldID0gcGFyc2VkQXJnc1trZXldICE9PSB2b2lkIDA7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcGFyc2VkQXJncztcbn1cblxuZnVuY3Rpb24gcGFyc2VNb2RlcyAobW9kZXNTdHIsIHVzZXJBcmdzKSB7XG4gICAgY29uc3QgcGFyc2VkICAgICAgICA9IHNwbGl0RXNjYXBlZChtb2Rlc1N0ciwgJzonKTtcbiAgICBjb25zdCBwYXRoICAgICAgICAgID0gZ2V0UGF0aEZyb21QYXJzZWRNb2RlcyhwYXJzZWQsIEFWQUlMQUJMRV9NT0RFUyk7XG4gICAgY29uc3QgZGV0ZWN0ZWRNb2RlcyA9IGdldE1vZGVzKHBhcnNlZCwgQVZBSUxBQkxFX01PREVTKTtcbiAgICBsZXQgb3B0aW9uc1N0cmluZyA9ICcnO1xuXG4gICAgaWYgKHBhcnNlZC5sZW5ndGgpXG4gICAgICAgIG9wdGlvbnNTdHJpbmcgPSBwYXJzZWQuc2hpZnQoKTtcblxuICAgIHdoaWxlIChwYXJzZWQubGVuZ3RoKVxuICAgICAgICBvcHRpb25zU3RyaW5nICs9ICc6JyArIHBhcnNlZC5zaGlmdCgpO1xuXG4gICAgY29uc3QgdXNlclByb2ZpbGUgPSBkZXRlY3RlZE1vZGVzLnVzZXJQcm9maWxlIHx8IHVzZXJBcmdzLnVzZXJEYXRhRGlyO1xuICAgIGNvbnN0IGhlYWRsZXNzICAgID0gZGV0ZWN0ZWRNb2Rlcy5oZWFkbGVzcyB8fCB1c2VyQXJncy5oZWFkbGVzcztcbiAgICBjb25zdCBlbXVsYXRpb24gICA9IGRldGVjdGVkTW9kZXMuZW11bGF0aW9uIHx8IGhlYWRsZXNzO1xuXG4gICAgY29uc3QgbW9kZXMgPSB7XG4gICAgICAgIHBhdGgsXG4gICAgICAgIHVzZXJQcm9maWxlLFxuICAgICAgICBoZWFkbGVzcyxcbiAgICAgICAgZW11bGF0aW9uXG4gICAgfTtcblxuICAgIHJldHVybiB7IG1vZGVzLCBvcHRpb25zU3RyaW5nIH07XG59XG5cbmZ1bmN0aW9uIHNpbXBsaWZ5RGV2aWNlTmFtZSAoZGV2aWNlTmFtZSkge1xuICAgIHJldHVybiBkZXZpY2VOYW1lLnJlcGxhY2UoL1xccy9nLCAnJykudG9Mb3dlckNhc2UoKTtcbn1cblxuZnVuY3Rpb24gZmluZERldmljZSAoZGV2aWNlTmFtZSkge1xuICAgIGNvbnN0IHNpbXBsZU5hbWUgPSBzaW1wbGlmeURldmljZU5hbWUoZGV2aWNlTmFtZSk7XG5cbiAgICByZXR1cm4gZW11bGF0ZWREZXZpY2VzLmZpbHRlcihkZXZpY2UgPT4gc2ltcGxpZnlEZXZpY2VOYW1lKGRldmljZS50aXRsZSkuaW5kZXhPZihzaW1wbGVOYW1lKSA+PSAwKVswXTtcbn1cblxuZnVuY3Rpb24gZ2V0RGV2aWNlQmFzZWRPcHRpb25zIChkZXZpY2VOYW1lLCBvcmllbnRhdGlvbikge1xuICAgIGlmICghZGV2aWNlTmFtZSlcbiAgICAgICAgcmV0dXJuIHt9O1xuXG4gICAgY29uc3QgZGV2aWNlRGF0YSA9IGZpbmREZXZpY2UoZGV2aWNlTmFtZSk7XG5cbiAgICBpZiAoIWRldmljZURhdGEpXG4gICAgICAgIHJldHVybiB7fTtcblxuICAgIGNvbnN0IG1vYmlsZSA9IGRldmljZURhdGEuY2FwYWJpbGl0aWVzLmluZGV4T2YoJ21vYmlsZScpID49IDA7XG5cbiAgICBpZiAoIW9yaWVudGF0aW9uKVxuICAgICAgICBvcmllbnRhdGlvbiA9IG1vYmlsZSA/ICd2ZXJ0aWNhbCcgOiAnaG9yaXpvbnRhbCc7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBtb2JpbGU6ICAgICAgbW9iaWxlLFxuICAgICAgICBvcmllbnRhdGlvbjogb3JpZW50YXRpb24sXG4gICAgICAgIHRvdWNoOiAgICAgICBkZXZpY2VEYXRhLmNhcGFiaWxpdGllcy5pbmRleE9mKCd0b3VjaCcpID49IDAsXG4gICAgICAgIHdpZHRoOiAgICAgICBkZXZpY2VEYXRhLnNjcmVlbltvcmllbnRhdGlvbl0ud2lkdGgsXG4gICAgICAgIGhlaWdodDogICAgICBkZXZpY2VEYXRhLnNjcmVlbltvcmllbnRhdGlvbl0uaGVpZ2h0LFxuICAgICAgICBzY2FsZUZhY3RvcjogZGV2aWNlRGF0YS5zY3JlZW5bJ2RldmljZS1waXhlbC1yYXRpbyddLFxuICAgICAgICB1c2VyQWdlbnQ6ICAgZGV2aWNlRGF0YVsndXNlci1hZ2VudCddLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIHBhcnNlT3B0aW9ucyAoc3RyLCB1c2VEZWZhdWx0RGltZW5zaW9ucykge1xuICAgIGNvbnN0IHBhcnNlZCA9IHNwbGl0RXNjYXBlZChzdHIsICc7Jyk7XG5cbiAgICBjb25zdCBiYXNlT3B0aW9ucyA9IHtcbiAgICAgICAgd2lkdGg6ICAgICAgIHVzZURlZmF1bHREaW1lbnNpb25zID8gSEVBRExFU1NfREVGQVVMVF9XSURUSCA6IDAsXG4gICAgICAgIGhlaWdodDogICAgICB1c2VEZWZhdWx0RGltZW5zaW9ucyA/IEhFQURMRVNTX0RFRkFVTFRfSEVJR0hUIDogMCxcbiAgICAgICAgc2NhbGVGYWN0b3I6IDAsXG4gICAgICAgIG1vYmlsZTogICAgICBmYWxzZSxcbiAgICAgICAgY2RwUG9ydDogICAgIGZpbmRNYXRjaChwYXJzZWQsIC9eY2RwUG9ydD0oLiopLylcbiAgICB9O1xuXG4gICAgY29uc3QgZGV2aWNlTmFtZSAgICAgICAgID0gZmluZE1hdGNoKHBhcnNlZCwgL15kZXZpY2U9KC4qKS8pO1xuICAgIGNvbnN0IG9yaWVudGF0aW9uICAgICAgICA9IGZpbmRNYXRjaChwYXJzZWQsIC9eb3JpZW50YXRpb249KC4qKS8pO1xuICAgIGNvbnN0IGRldmljZUJhc2VkT3B0aW9ucyA9IGdldERldmljZUJhc2VkT3B0aW9ucyhkZXZpY2VOYW1lLCBvcmllbnRhdGlvbik7XG5cbiAgICBsZXQgc3BlY2lmaWVkRGV2aWNlT3B0aW9ucyA9IHtcbiAgICAgICAgb3JpZW50YXRpb246IG9yaWVudGF0aW9uLFxuICAgICAgICB0b3VjaDogICAgICAgaGFzTWF0Y2gocGFyc2VkLCAvXnRvdWNoPS8pID8gaXNNYXRjaFRydWUocGFyc2VkLCAvXnRvdWNoPSguKikvKSA6IHZvaWQgMCxcbiAgICAgICAgbW9iaWxlOiAgICAgIGlzTWF0Y2hUcnVlKHBhcnNlZCwgL15tb2JpbGU9KC4qKS8pLFxuICAgICAgICB3aWR0aDogICAgICAgTnVtYmVyKGZpbmRNYXRjaChwYXJzZWQsIC9ed2lkdGg9KC4qKS8pIHx8IE5hTiksXG4gICAgICAgIGhlaWdodDogICAgICBOdW1iZXIoZmluZE1hdGNoKHBhcnNlZCwgL15oZWlnaHQ9KC4qKS8pIHx8IE5hTiksXG4gICAgICAgIHNjYWxlRmFjdG9yOiBOdW1iZXIoZmluZE1hdGNoKHBhcnNlZCwgL15zY2FsZUZhY3Rvcj0oLiopLykgfHwgTmFOKSxcbiAgICAgICAgdXNlckFnZW50OiAgIGZpbmRNYXRjaChwYXJzZWQsIC9edXNlckFnZW50PSguKikvKVxuICAgIH07XG5cbiAgICBzcGVjaWZpZWREZXZpY2VPcHRpb25zID0gZmlsdGVyUHJvcGVydGllcyhzcGVjaWZpZWREZXZpY2VPcHRpb25zLCBvcHRpb25WYWx1ZSA9PiB7XG4gICAgICAgIHJldHVybiBvcHRpb25WYWx1ZSAhPT0gdm9pZCAwICYmIG9wdGlvblZhbHVlICE9PSAnJyAmJiAhTnVtYmVyLmlzTmFOKG9wdGlvblZhbHVlKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKGJhc2VPcHRpb25zLCBkZXZpY2VCYXNlZE9wdGlvbnMsIHNwZWNpZmllZERldmljZU9wdGlvbnMpO1xufVxuXG5cbmZ1bmN0aW9uIGdldE5ld0NvbmZpZyAoY29uZmlnU3RyaW5nKSB7XG4gICAgY29uc3QgeyB1c2VyQXJncywgbW9kZXNTdHJpbmcgfSA9IHBhcnNlQ29uZmlnKGNvbmZpZ1N0cmluZyk7XG4gICAgY29uc3QgcGFyc2VkVXNlckFyZ3MgICAgICAgICAgICA9IHBhcnNlVXNlckFyZ3ModXNlckFyZ3MpO1xuICAgIGNvbnN0IHsgbW9kZXMsIG9wdGlvbnNTdHJpbmcgfSAgPSBwYXJzZU1vZGVzKG1vZGVzU3RyaW5nLCBwYXJzZWRVc2VyQXJncyk7XG4gICAgY29uc3QgdXNlRGVmYXVsdERpbWVuc2lvbnMgICAgICA9IG1vZGVzLmhlYWRsZXNzICYmICFwYXJzZWRVc2VyQXJncy53aW5kb3dTaXplO1xuICAgIGNvbnN0IG9wdGlvbnMgICAgICAgICAgICAgICAgICAgPSBwYXJzZU9wdGlvbnMob3B0aW9uc1N0cmluZywgdXNlRGVmYXVsdERpbWVuc2lvbnMpO1xuXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oeyB1c2VyQXJncyB9LCBtb2Rlcywgb3B0aW9ucyk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChjb25maWdTdHJpbmcpIHtcbiAgICBpZiAoIWNvbmZpZ0NhY2hlW2NvbmZpZ1N0cmluZ10pXG4gICAgICAgIGNvbmZpZ0NhY2hlW2NvbmZpZ1N0cmluZ10gPSBnZXROZXdDb25maWcoY29uZmlnU3RyaW5nKTtcblxuICAgIHJldHVybiBjb25maWdDYWNoZVtjb25maWdTdHJpbmddO1xufVxuIl19
