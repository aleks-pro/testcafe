'use strict';

exports.__esModule = true;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

exports.default = compileClientFunction;

var _testcafeHammerhead = require('testcafe-hammerhead');

var _testcafeHammerhead2 = _interopRequireDefault(_testcafeHammerhead);

var _asyncToGenerator = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator2 = _interopRequireDefault(_asyncToGenerator);

var _lodash = require('lodash');

var _loadBabelLibs3 = require('./load-babel-libs');

var _loadBabelLibs4 = _interopRequireDefault(_loadBabelLibs3);

var _runtime = require('../errors/runtime');

var _types = require('../errors/types');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ANONYMOUS_FN_RE = /^function\s*\*?\s*\(/;
const ES6_OBJ_METHOD_NAME_RE = /^(\S+?)\s*\(/;
const USE_STRICT_RE = /^('|")use strict('|");?/;
const TRAILING_SEMICOLON_RE = /;\s*$/;
const REGENERATOR_FOOTPRINTS_RE = /(_index\d+\.default|_regenerator\d+\.default|regeneratorRuntime)\.wrap\(function _callee\$\(_context\)/;
const ASYNC_TO_GENERATOR_OUTPUT_CODE = (0, _asyncToGenerator2.default)(_lodash.noop).toString();

const babelArtifactPolyfills = {
    'Promise': {
        re: /_promise(\d+)\.default/,
        getCode: match => `var _promise${match[1]} = { default: Promise };`,
        removeMatchingCode: false
    },

    'Object.keys()': {
        re: /_keys(\d+)\.default/,
        getCode: match => `var _keys${match[1]} = { default: Object.keys };`,
        removeMatchingCode: false
    },

    'JSON.stringify()': {
        re: /_stringify(\d+)\.default/,
        getCode: match => `var _stringify${match[1]} = { default: JSON.stringify };`,
        removeMatchingCode: false
    }
};

function getBabelOptions() {
    var _loadBabelLibs = (0, _loadBabelLibs4.default)();

    const presetFallback = _loadBabelLibs.presetFallback,
          transformForOfAsArray = _loadBabelLibs.transformForOfAsArray;


    return {
        presets: [{ plugins: [transformForOfAsArray] }, presetFallback],
        sourceMaps: false,
        retainLines: true,
        ast: false,
        babelrc: false,
        highlightCode: false
    };
}

function downgradeES(fnCode) {
    var _loadBabelLibs2 = (0, _loadBabelLibs4.default)();

    const babel = _loadBabelLibs2.babel;


    const opts = getBabelOptions();
    const compiled = babel.transform(fnCode, opts);

    return compiled.code.replace(USE_STRICT_RE, '').trim();
}

function addBabelArtifactsPolyfills(fnCode, dependenciesDefinition) {
    let modifiedFnCode = fnCode;

    const polyfills = (0, _values2.default)(babelArtifactPolyfills).reduce((polyfillsCode, polyfill) => {
        const match = fnCode.match(polyfill.re);

        if (match) {
            if (polyfill.removeMatchingCode) modifiedFnCode = modifiedFnCode.replace(polyfill.re, '');

            return polyfillsCode + polyfill.getCode(match);
        }

        return polyfillsCode;
    }, '');

    return `(function(){${dependenciesDefinition}${polyfills} return ${modifiedFnCode}})();`;
}

function getDependenciesDefinition(dependencies) {
    return (0, _keys2.default)(dependencies).reduce((code, name) => {
        return code + `var ${name}=__dependencies$['${name}'];`;
    }, '');
}

function makeFnCodeSuitableForParsing(fnCode) {
    // NOTE: 'function() {}' -> '(function() {})'
    if (ANONYMOUS_FN_RE.test(fnCode)) return `(${fnCode})`;

    // NOTE: 'myFn () {}' -> 'function myFn() {}'
    const match = fnCode.match(ES6_OBJ_METHOD_NAME_RE);

    if (match && match[1] !== 'function') return `function ${fnCode}`;

    return fnCode;
}

function compileClientFunction(fnCode, dependencies, instantiationCallsiteName, compilationCallsiteName) {
    if (fnCode === ASYNC_TO_GENERATOR_OUTPUT_CODE) throw new _runtime.ClientFunctionAPIError(compilationCallsiteName, instantiationCallsiteName, _types.RUNTIME_ERRORS.regeneratorInClientFunctionCode);

    fnCode = makeFnCodeSuitableForParsing(fnCode);

    // NOTE: we need to recompile ES6 code for the browser if we are on newer versions of Node.
    fnCode = downgradeES(fnCode);
    fnCode = _testcafeHammerhead2.default.processScript(fnCode, false);

    // NOTE: check compiled code for regenerator injection: we have either generator
    // recompiled in Node.js 4+ for client or async function declared in function code.
    if (REGENERATOR_FOOTPRINTS_RE.test(fnCode)) throw new _runtime.ClientFunctionAPIError(compilationCallsiteName, instantiationCallsiteName, _types.RUNTIME_ERRORS.regeneratorInClientFunctionCode);

    if (!TRAILING_SEMICOLON_RE.test(fnCode)) fnCode += ';';

    const dependenciesDefinition = dependencies ? getDependenciesDefinition(dependencies) : '';

    return addBabelArtifactsPolyfills(fnCode, dependenciesDefinition);
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21waWxlci9jb21waWxlLWNsaWVudC1mdW5jdGlvbi5qcyJdLCJuYW1lcyI6WyJjb21waWxlQ2xpZW50RnVuY3Rpb24iLCJBTk9OWU1PVVNfRk5fUkUiLCJFUzZfT0JKX01FVEhPRF9OQU1FX1JFIiwiVVNFX1NUUklDVF9SRSIsIlRSQUlMSU5HX1NFTUlDT0xPTl9SRSIsIlJFR0VORVJBVE9SX0ZPT1RQUklOVFNfUkUiLCJBU1lOQ19UT19HRU5FUkFUT1JfT1VUUFVUX0NPREUiLCJ0b1N0cmluZyIsImJhYmVsQXJ0aWZhY3RQb2x5ZmlsbHMiLCJyZSIsImdldENvZGUiLCJtYXRjaCIsInJlbW92ZU1hdGNoaW5nQ29kZSIsImdldEJhYmVsT3B0aW9ucyIsInByZXNldEZhbGxiYWNrIiwidHJhbnNmb3JtRm9yT2ZBc0FycmF5IiwicHJlc2V0cyIsInBsdWdpbnMiLCJzb3VyY2VNYXBzIiwicmV0YWluTGluZXMiLCJhc3QiLCJiYWJlbHJjIiwiaGlnaGxpZ2h0Q29kZSIsImRvd25ncmFkZUVTIiwiZm5Db2RlIiwiYmFiZWwiLCJvcHRzIiwiY29tcGlsZWQiLCJ0cmFuc2Zvcm0iLCJjb2RlIiwicmVwbGFjZSIsInRyaW0iLCJhZGRCYWJlbEFydGlmYWN0c1BvbHlmaWxscyIsImRlcGVuZGVuY2llc0RlZmluaXRpb24iLCJtb2RpZmllZEZuQ29kZSIsInBvbHlmaWxscyIsInJlZHVjZSIsInBvbHlmaWxsc0NvZGUiLCJwb2x5ZmlsbCIsImdldERlcGVuZGVuY2llc0RlZmluaXRpb24iLCJkZXBlbmRlbmNpZXMiLCJuYW1lIiwibWFrZUZuQ29kZVN1aXRhYmxlRm9yUGFyc2luZyIsInRlc3QiLCJpbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lIiwiY29tcGlsYXRpb25DYWxsc2l0ZU5hbWUiLCJyZWdlbmVyYXRvckluQ2xpZW50RnVuY3Rpb25Db2RlIiwicHJvY2Vzc1NjcmlwdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O2tCQXNHd0JBLHFC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QjBDLElBQWhCLENBQXFCbkIsTUFBckIsQ0FBSixFQUNJLE9BQVEsSUFBR0EsTUFBTyxHQUFsQjs7QUFFSjtBQUNBLFVBQU1iLFFBQVFhLE9BQU9iLEtBQVAsQ0FBYVQsc0JBQWIsQ0FBZDs7QUFFQSxRQUFJUyxTQUFTQSxNQUFNLENBQU4sTUFBYSxVQUExQixFQUNJLE9BQVEsWUFBV2EsTUFBTyxFQUExQjs7QUFFSixXQUFPQSxNQUFQO0FBQ0g7O0FBRWMsU0FBU3hCLHFCQUFULENBQWdDd0IsTUFBaEMsRUFBd0NnQixZQUF4QyxFQUFzREkseUJBQXRELEVBQWlGQyx1QkFBakYsRUFBMEc7QUFDckgsUUFBSXJCLFdBQVdsQiw4QkFBZixFQUNJLE1BQU0sb0NBQTJCdUMsdUJBQTNCLEVBQW9ERCx5QkFBcEQsRUFBK0Usc0JBQWVFLCtCQUE5RixDQUFOOztBQUVKdEIsYUFBU2tCLDZCQUE2QmxCLE1BQTdCLENBQVQ7O0FBRUE7QUFDQUEsYUFBU0QsWUFBWUMsTUFBWixDQUFUO0FBQ0FBLGFBQVMsNkJBQVd1QixhQUFYLENBQXlCdkIsTUFBekIsRUFBaUMsS0FBakMsQ0FBVDs7QUFFQTtBQUNBO0FBQ0EsUUFBSW5CLDBCQUEwQnNDLElBQTFCLENBQStCbkIsTUFBL0IsQ0FBSixFQUNJLE1BQU0sb0NBQTJCcUIsdUJBQTNCLEVBQW9ERCx5QkFBcEQsRUFBK0Usc0JBQWVFLCtCQUE5RixDQUFOOztBQUVKLFFBQUksQ0FBQzFDLHNCQUFzQnVDLElBQXRCLENBQTJCbkIsTUFBM0IsQ0FBTCxFQUNJQSxVQUFVLEdBQVY7O0FBRUosVUFBTVMseUJBQXlCTyxlQUFlRCwwQkFBMEJDLFlBQTFCLENBQWYsR0FBeUQsRUFBeEY7O0FBRUEsV0FBT1IsMkJBQTJCUixNQUEzQixFQUFtQ1Msc0JBQW5DLENBQVA7QUFDSCIsImZpbGUiOiJjb21waWxlci9jb21waWxlLWNsaWVudC1mdW5jdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBoYW1tZXJoZWFkIGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IGFzeW5jVG9HZW5lcmF0b3IgZnJvbSAnYmFiZWwtcnVudGltZS9oZWxwZXJzL2FzeW5jVG9HZW5lcmF0b3InO1xuaW1wb3J0IHsgbm9vcCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9hZEJhYmVsTGlicyBmcm9tICcuL2xvYWQtYmFiZWwtbGlicyc7XG5pbXBvcnQgeyBDbGllbnRGdW5jdGlvbkFQSUVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi9lcnJvcnMvdHlwZXMnO1xuXG5jb25zdCBBTk9OWU1PVVNfRk5fUkUgICAgICAgICAgICAgICAgPSAvXmZ1bmN0aW9uXFxzKlxcKj9cXHMqXFwoLztcbmNvbnN0IEVTNl9PQkpfTUVUSE9EX05BTUVfUkUgICAgICAgICA9IC9eKFxcUys/KVxccypcXCgvO1xuY29uc3QgVVNFX1NUUklDVF9SRSAgICAgICAgICAgICAgICAgID0gL14oJ3xcIil1c2Ugc3RyaWN0KCd8XCIpOz8vO1xuY29uc3QgVFJBSUxJTkdfU0VNSUNPTE9OX1JFICAgICAgICAgID0gLztcXHMqJC87XG5jb25zdCBSRUdFTkVSQVRPUl9GT09UUFJJTlRTX1JFICAgICAgPSAvKF9pbmRleFxcZCtcXC5kZWZhdWx0fF9yZWdlbmVyYXRvclxcZCtcXC5kZWZhdWx0fHJlZ2VuZXJhdG9yUnVudGltZSlcXC53cmFwXFwoZnVuY3Rpb24gX2NhbGxlZVxcJFxcKF9jb250ZXh0XFwpLztcbmNvbnN0IEFTWU5DX1RPX0dFTkVSQVRPUl9PVVRQVVRfQ09ERSA9IGFzeW5jVG9HZW5lcmF0b3Iobm9vcCkudG9TdHJpbmcoKTtcblxuY29uc3QgYmFiZWxBcnRpZmFjdFBvbHlmaWxscyA9IHtcbiAgICAnUHJvbWlzZSc6IHtcbiAgICAgICAgcmU6ICAgICAgICAgICAgICAgICAvX3Byb21pc2UoXFxkKylcXC5kZWZhdWx0LyxcbiAgICAgICAgZ2V0Q29kZTogICAgICAgICAgICBtYXRjaCA9PiBgdmFyIF9wcm9taXNlJHttYXRjaFsxXX0gPSB7IGRlZmF1bHQ6IFByb21pc2UgfTtgLFxuICAgICAgICByZW1vdmVNYXRjaGluZ0NvZGU6IGZhbHNlXG4gICAgfSxcblxuICAgICdPYmplY3Qua2V5cygpJzoge1xuICAgICAgICByZTogICAgICAgICAgICAgICAgIC9fa2V5cyhcXGQrKVxcLmRlZmF1bHQvLFxuICAgICAgICBnZXRDb2RlOiAgICAgICAgICAgIG1hdGNoID0+IGB2YXIgX2tleXMke21hdGNoWzFdfSA9IHsgZGVmYXVsdDogT2JqZWN0LmtleXMgfTtgLFxuICAgICAgICByZW1vdmVNYXRjaGluZ0NvZGU6IGZhbHNlXG4gICAgfSxcblxuICAgICdKU09OLnN0cmluZ2lmeSgpJzoge1xuICAgICAgICByZTogICAgICAgICAgICAgICAgIC9fc3RyaW5naWZ5KFxcZCspXFwuZGVmYXVsdC8sXG4gICAgICAgIGdldENvZGU6ICAgICAgICAgICAgbWF0Y2ggPT4gYHZhciBfc3RyaW5naWZ5JHttYXRjaFsxXX0gPSB7IGRlZmF1bHQ6IEpTT04uc3RyaW5naWZ5IH07YCxcbiAgICAgICAgcmVtb3ZlTWF0Y2hpbmdDb2RlOiBmYWxzZVxuICAgIH1cbn07XG5cblxuZnVuY3Rpb24gZ2V0QmFiZWxPcHRpb25zICgpIHtcbiAgICBjb25zdCB7IHByZXNldEZhbGxiYWNrLCB0cmFuc2Zvcm1Gb3JPZkFzQXJyYXkgfSA9IGxvYWRCYWJlbExpYnMoKTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHByZXNldHM6ICAgICAgIFt7IHBsdWdpbnM6IFt0cmFuc2Zvcm1Gb3JPZkFzQXJyYXldIH0sIHByZXNldEZhbGxiYWNrXSxcbiAgICAgICAgc291cmNlTWFwczogICAgZmFsc2UsXG4gICAgICAgIHJldGFpbkxpbmVzOiAgIHRydWUsXG4gICAgICAgIGFzdDogICAgICAgICAgIGZhbHNlLFxuICAgICAgICBiYWJlbHJjOiAgICAgICBmYWxzZSxcbiAgICAgICAgaGlnaGxpZ2h0Q29kZTogZmFsc2VcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBkb3duZ3JhZGVFUyAoZm5Db2RlKSB7XG4gICAgY29uc3QgeyBiYWJlbCB9ID0gbG9hZEJhYmVsTGlicygpO1xuXG4gICAgY29uc3Qgb3B0cyAgICAgPSBnZXRCYWJlbE9wdGlvbnMoKTtcbiAgICBjb25zdCBjb21waWxlZCA9IGJhYmVsLnRyYW5zZm9ybShmbkNvZGUsIG9wdHMpO1xuXG4gICAgcmV0dXJuIGNvbXBpbGVkLmNvZGVcbiAgICAgICAgLnJlcGxhY2UoVVNFX1NUUklDVF9SRSwgJycpXG4gICAgICAgIC50cmltKCk7XG59XG5cbmZ1bmN0aW9uIGFkZEJhYmVsQXJ0aWZhY3RzUG9seWZpbGxzIChmbkNvZGUsIGRlcGVuZGVuY2llc0RlZmluaXRpb24pIHtcbiAgICBsZXQgbW9kaWZpZWRGbkNvZGUgPSBmbkNvZGU7XG5cbiAgICBjb25zdCBwb2x5ZmlsbHMgPSBPYmplY3RcbiAgICAgICAgLnZhbHVlcyhiYWJlbEFydGlmYWN0UG9seWZpbGxzKVxuICAgICAgICAucmVkdWNlKChwb2x5ZmlsbHNDb2RlLCBwb2x5ZmlsbCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBmbkNvZGUubWF0Y2gocG9seWZpbGwucmUpO1xuXG4gICAgICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICAgICAgICBpZiAocG9seWZpbGwucmVtb3ZlTWF0Y2hpbmdDb2RlKVxuICAgICAgICAgICAgICAgICAgICBtb2RpZmllZEZuQ29kZSA9IG1vZGlmaWVkRm5Db2RlLnJlcGxhY2UocG9seWZpbGwucmUsICcnKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBwb2x5ZmlsbHNDb2RlICsgcG9seWZpbGwuZ2V0Q29kZShtYXRjaCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBwb2x5ZmlsbHNDb2RlO1xuICAgICAgICB9LCAnJyk7XG5cbiAgICByZXR1cm4gYChmdW5jdGlvbigpeyR7ZGVwZW5kZW5jaWVzRGVmaW5pdGlvbn0ke3BvbHlmaWxsc30gcmV0dXJuICR7bW9kaWZpZWRGbkNvZGV9fSkoKTtgO1xufVxuXG5mdW5jdGlvbiBnZXREZXBlbmRlbmNpZXNEZWZpbml0aW9uIChkZXBlbmRlbmNpZXMpIHtcbiAgICByZXR1cm4gT2JqZWN0XG4gICAgICAgIC5rZXlzKGRlcGVuZGVuY2llcylcbiAgICAgICAgLnJlZHVjZSgoY29kZSwgbmFtZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGNvZGUgKyBgdmFyICR7bmFtZX09X19kZXBlbmRlbmNpZXMkWycke25hbWV9J107YDtcbiAgICAgICAgfSwgJycpO1xufVxuXG5mdW5jdGlvbiBtYWtlRm5Db2RlU3VpdGFibGVGb3JQYXJzaW5nIChmbkNvZGUpIHtcbiAgICAvLyBOT1RFOiAnZnVuY3Rpb24oKSB7fScgLT4gJyhmdW5jdGlvbigpIHt9KSdcbiAgICBpZiAoQU5PTllNT1VTX0ZOX1JFLnRlc3QoZm5Db2RlKSlcbiAgICAgICAgcmV0dXJuIGAoJHtmbkNvZGV9KWA7XG5cbiAgICAvLyBOT1RFOiAnbXlGbiAoKSB7fScgLT4gJ2Z1bmN0aW9uIG15Rm4oKSB7fSdcbiAgICBjb25zdCBtYXRjaCA9IGZuQ29kZS5tYXRjaChFUzZfT0JKX01FVEhPRF9OQU1FX1JFKTtcblxuICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSAhPT0gJ2Z1bmN0aW9uJylcbiAgICAgICAgcmV0dXJuIGBmdW5jdGlvbiAke2ZuQ29kZX1gO1xuXG4gICAgcmV0dXJuIGZuQ29kZTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY29tcGlsZUNsaWVudEZ1bmN0aW9uIChmbkNvZGUsIGRlcGVuZGVuY2llcywgaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSwgY29tcGlsYXRpb25DYWxsc2l0ZU5hbWUpIHtcbiAgICBpZiAoZm5Db2RlID09PSBBU1lOQ19UT19HRU5FUkFUT1JfT1VUUFVUX0NPREUpXG4gICAgICAgIHRocm93IG5ldyBDbGllbnRGdW5jdGlvbkFQSUVycm9yKGNvbXBpbGF0aW9uQ2FsbHNpdGVOYW1lLCBpbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lLCBSVU5USU1FX0VSUk9SUy5yZWdlbmVyYXRvckluQ2xpZW50RnVuY3Rpb25Db2RlKTtcblxuICAgIGZuQ29kZSA9IG1ha2VGbkNvZGVTdWl0YWJsZUZvclBhcnNpbmcoZm5Db2RlKTtcblxuICAgIC8vIE5PVEU6IHdlIG5lZWQgdG8gcmVjb21waWxlIEVTNiBjb2RlIGZvciB0aGUgYnJvd3NlciBpZiB3ZSBhcmUgb24gbmV3ZXIgdmVyc2lvbnMgb2YgTm9kZS5cbiAgICBmbkNvZGUgPSBkb3duZ3JhZGVFUyhmbkNvZGUpO1xuICAgIGZuQ29kZSA9IGhhbW1lcmhlYWQucHJvY2Vzc1NjcmlwdChmbkNvZGUsIGZhbHNlKTtcblxuICAgIC8vIE5PVEU6IGNoZWNrIGNvbXBpbGVkIGNvZGUgZm9yIHJlZ2VuZXJhdG9yIGluamVjdGlvbjogd2UgaGF2ZSBlaXRoZXIgZ2VuZXJhdG9yXG4gICAgLy8gcmVjb21waWxlZCBpbiBOb2RlLmpzIDQrIGZvciBjbGllbnQgb3IgYXN5bmMgZnVuY3Rpb24gZGVjbGFyZWQgaW4gZnVuY3Rpb24gY29kZS5cbiAgICBpZiAoUkVHRU5FUkFUT1JfRk9PVFBSSU5UU19SRS50ZXN0KGZuQ29kZSkpXG4gICAgICAgIHRocm93IG5ldyBDbGllbnRGdW5jdGlvbkFQSUVycm9yKGNvbXBpbGF0aW9uQ2FsbHNpdGVOYW1lLCBpbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lLCBSVU5USU1FX0VSUk9SUy5yZWdlbmVyYXRvckluQ2xpZW50RnVuY3Rpb25Db2RlKTtcblxuICAgIGlmICghVFJBSUxJTkdfU0VNSUNPTE9OX1JFLnRlc3QoZm5Db2RlKSlcbiAgICAgICAgZm5Db2RlICs9ICc7JztcblxuICAgIGNvbnN0IGRlcGVuZGVuY2llc0RlZmluaXRpb24gPSBkZXBlbmRlbmNpZXMgPyBnZXREZXBlbmRlbmNpZXNEZWZpbml0aW9uKGRlcGVuZGVuY2llcykgOiAnJztcblxuICAgIHJldHVybiBhZGRCYWJlbEFydGlmYWN0c1BvbHlmaWxscyhmbkNvZGUsIGRlcGVuZGVuY2llc0RlZmluaXRpb24pO1xufVxuIl19
