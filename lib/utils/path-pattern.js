'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _lodash = require('lodash');

var _correctFilePath = require('../utils/correct-file-path');

var _correctFilePath2 = _interopRequireDefault(_correctFilePath);

var _escapeUserAgent = require('../utils/escape-user-agent');

var _escapeUserAgent2 = _interopRequireDefault(_escapeUserAgent);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DATE_FORMAT = 'YYYY-MM-DD';
const TIME_FORMAT = 'HH-mm-ss';

const ERRORS_FOLDER = 'errors';

const PROBLEMATIC_PLACEHOLDER_VALUE = '';

const PLACEHOLDERS = {
    DATE: '${DATE}',
    TIME: '${TIME}',
    TEST_INDEX: '${TEST_INDEX}',
    FILE_INDEX: '${FILE_INDEX}',
    QUARANTINE_ATTEMPT: '${QUARANTINE_ATTEMPT}',
    FIXTURE: '${FIXTURE}',
    TEST: '${TEST}',
    USERAGENT: '${USERAGENT}',
    BROWSER: '${BROWSER}',
    BROWSER_VERSION: '${BROWSER_VERSION}',
    OS: '${OS}',
    OS_VERSION: '${OS_VERSION}',
    TEST_ID: '${TEST_ID}',
    RUN_ID: '${RUN_ID}'
};

const DEFAULT_PATH_PATTERN_FOR_REPORT = `${PLACEHOLDERS.DATE}_${PLACEHOLDERS.TIME}\\${PLACEHOLDERS.TEST_ID}\\` + `${PLACEHOLDERS.RUN_ID}\\${PLACEHOLDERS.USERAGENT}\\${PLACEHOLDERS.FILE_INDEX}`;

const TEST_ID_TEMPLATE = data => data.testIndex ? `test-${data.testIndex}` : '';
const RUN_ID_TEMPLATE = data => data.quarantineAttempt ? `run-${data.quarantineAttempt}` : '';

class PathPattern extends _events2.default {
    constructor(pattern, fileExtension, data) {
        super();

        this.pattern = this._ensurePattern(pattern);
        this.data = this._addDefaultFields(data);
        this.placeholderToDataMap = this._createPlaceholderToDataMap();
        this.fileExtension = fileExtension;
    }

    _ensurePattern(pattern) {
        if (pattern) return pattern;

        return DEFAULT_PATH_PATTERN_FOR_REPORT;
    }

    _addDefaultFields(data) {
        const defaultFields = {
            testId: TEST_ID_TEMPLATE(data),
            runId: RUN_ID_TEMPLATE(data),
            formattedDate: data.now.format(DATE_FORMAT),
            formattedTime: data.now.format(TIME_FORMAT),
            fileIndex: 1,
            errorFileIndex: 1
        };

        return (0, _assign2.default)({}, defaultFields, data);
    }

    _createPlaceholderToDataMap() {
        return {
            [PLACEHOLDERS.TEST_ID]: this.data.testId,
            [PLACEHOLDERS.RUN_ID]: this.data.runId,
            [PLACEHOLDERS.DATE]: this.data.formattedDate,
            [PLACEHOLDERS.TIME]: this.data.formattedTime,
            [PLACEHOLDERS.TEST_INDEX]: this.data.testIndex,
            [PLACEHOLDERS.QUARANTINE_ATTEMPT]: this.data.quarantineAttempt || 1,
            [PLACEHOLDERS.FIXTURE]: this.data.fixture,
            [PLACEHOLDERS.TEST]: this.data.test,
            [PLACEHOLDERS.FILE_INDEX]: forError => forError ? this.data.errorFileIndex : this.data.fileIndex,
            [PLACEHOLDERS.USERAGENT]: this.data.parsedUserAgent.toString(),
            [PLACEHOLDERS.BROWSER]: this.data.parsedUserAgent.family,
            [PLACEHOLDERS.BROWSER_VERSION]: this.data.parsedUserAgent.toVersion(),
            [PLACEHOLDERS.OS]: this.data.parsedUserAgent.os.family,
            [PLACEHOLDERS.OS_VERSION]: this.data.parsedUserAgent.os.toVersion()
        };
    }

    _buildPath(pattern, placeholderToDataMap, forError) {
        let resultFilePath = pattern;
        const problematicPlaceholders = [];

        for (const placeholder in placeholderToDataMap) {
            const findPlaceholderRegExp = new RegExp((0, _lodash.escapeRegExp)(placeholder), 'g');

            resultFilePath = resultFilePath.replace(findPlaceholderRegExp, () => {
                if (placeholder === PLACEHOLDERS.FILE_INDEX) {
                    const getFileIndexFn = placeholderToDataMap[placeholder];
                    let result = getFileIndexFn(forError);

                    if (forError) result = `${ERRORS_FOLDER}\\${result}`;

                    return result;
                } else if (placeholder === PLACEHOLDERS.USERAGENT) {
                    const userAgent = placeholderToDataMap[placeholder];

                    return (0, _escapeUserAgent2.default)(userAgent);
                }

                let calculatedValue = placeholderToDataMap[placeholder];

                if (calculatedValue === null || calculatedValue === void 0) {
                    problematicPlaceholders.push(placeholder);

                    calculatedValue = PROBLEMATIC_PLACEHOLDER_VALUE;
                }

                return calculatedValue;
            });
        }

        if (problematicPlaceholders.length) this.emit('problematic-placeholders-found', { placeholders: problematicPlaceholders });

        return resultFilePath;
    }

    getPath(forError) {
        const path = this._buildPath(this.pattern, this.placeholderToDataMap, forError);

        return (0, _correctFilePath2.default)(path, this.fileExtension);
    }

    // For testing purposes
    static get PLACEHOLDERS() {
        return PLACEHOLDERS;
    }
}
exports.default = PathPattern;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9wYXRoLXBhdHRlcm4uanMiXSwibmFtZXMiOlsiREFURV9GT1JNQVQiLCJUSU1FX0ZPUk1BVCIsIkVSUk9SU19GT0xERVIiLCJQUk9CTEVNQVRJQ19QTEFDRUhPTERFUl9WQUxVRSIsIlBMQUNFSE9MREVSUyIsIkRBVEUiLCJUSU1FIiwiVEVTVF9JTkRFWCIsIkZJTEVfSU5ERVgiLCJRVUFSQU5USU5FX0FUVEVNUFQiLCJGSVhUVVJFIiwiVEVTVCIsIlVTRVJBR0VOVCIsIkJST1dTRVIiLCJCUk9XU0VSX1ZFUlNJT04iLCJPUyIsIk9TX1ZFUlNJT04iLCJURVNUX0lEIiwiUlVOX0lEIiwiREVGQVVMVF9QQVRIX1BBVFRFUk5fRk9SX1JFUE9SVCIsIlRFU1RfSURfVEVNUExBVEUiLCJkYXRhIiwidGVzdEluZGV4IiwiUlVOX0lEX1RFTVBMQVRFIiwicXVhcmFudGluZUF0dGVtcHQiLCJQYXRoUGF0dGVybiIsImNvbnN0cnVjdG9yIiwicGF0dGVybiIsImZpbGVFeHRlbnNpb24iLCJfZW5zdXJlUGF0dGVybiIsIl9hZGREZWZhdWx0RmllbGRzIiwicGxhY2Vob2xkZXJUb0RhdGFNYXAiLCJfY3JlYXRlUGxhY2Vob2xkZXJUb0RhdGFNYXAiLCJkZWZhdWx0RmllbGRzIiwidGVzdElkIiwicnVuSWQiLCJmb3JtYXR0ZWREYXRlIiwibm93IiwiZm9ybWF0IiwiZm9ybWF0dGVkVGltZSIsImZpbGVJbmRleCIsImVycm9yRmlsZUluZGV4IiwiZml4dHVyZSIsInRlc3QiLCJmb3JFcnJvciIsInBhcnNlZFVzZXJBZ2VudCIsInRvU3RyaW5nIiwiZmFtaWx5IiwidG9WZXJzaW9uIiwib3MiLCJfYnVpbGRQYXRoIiwicmVzdWx0RmlsZVBhdGgiLCJwcm9ibGVtYXRpY1BsYWNlaG9sZGVycyIsInBsYWNlaG9sZGVyIiwiZmluZFBsYWNlaG9sZGVyUmVnRXhwIiwiUmVnRXhwIiwicmVwbGFjZSIsImdldEZpbGVJbmRleEZuIiwicmVzdWx0IiwidXNlckFnZW50IiwiY2FsY3VsYXRlZFZhbHVlIiwicHVzaCIsImxlbmd0aCIsImVtaXQiLCJwbGFjZWhvbGRlcnMiLCJnZXRQYXRoIiwicGF0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLGNBQWMsWUFBcEI7QUFDQSxNQUFNQyxjQUFjLFVBQXBCOztBQUVBLE1BQU1DLGdCQUFnQixRQUF0Qjs7QUFFQSxNQUFNQyxnQ0FBZ0MsRUFBdEM7O0FBRUEsTUFBTUMsZUFBZTtBQUNqQkMsVUFBb0IsU0FESDtBQUVqQkMsVUFBb0IsU0FGSDtBQUdqQkMsZ0JBQW9CLGVBSEg7QUFJakJDLGdCQUFvQixlQUpIO0FBS2pCQyx3QkFBb0IsdUJBTEg7QUFNakJDLGFBQW9CLFlBTkg7QUFPakJDLFVBQW9CLFNBUEg7QUFRakJDLGVBQW9CLGNBUkg7QUFTakJDLGFBQW9CLFlBVEg7QUFVakJDLHFCQUFvQixvQkFWSDtBQVdqQkMsUUFBb0IsT0FYSDtBQVlqQkMsZ0JBQW9CLGVBWkg7QUFhakJDLGFBQW9CLFlBYkg7QUFjakJDLFlBQW9CO0FBZEgsQ0FBckI7O0FBaUJBLE1BQU1DLGtDQUFtQyxHQUFFZixhQUFhQyxJQUFLLElBQUdELGFBQWFFLElBQUssS0FBSUYsYUFBYWEsT0FBUSxJQUFuRSxHQUNDLEdBQUViLGFBQWFjLE1BQU8sS0FBSWQsYUFBYVEsU0FBVSxLQUFJUixhQUFhSSxVQUFXLEVBRHRIOztBQUdBLE1BQU1ZLG1CQUFtQkMsUUFBUUEsS0FBS0MsU0FBTCxHQUFrQixRQUFPRCxLQUFLQyxTQUFVLEVBQXhDLEdBQTRDLEVBQTdFO0FBQ0EsTUFBTUMsa0JBQW1CRixRQUFRQSxLQUFLRyxpQkFBTCxHQUEwQixPQUFNSCxLQUFLRyxpQkFBa0IsRUFBdkQsR0FBMkQsRUFBNUY7O0FBRWUsTUFBTUMsV0FBTiwwQkFBdUM7QUFDbERDLGdCQUFhQyxPQUFiLEVBQXNCQyxhQUF0QixFQUFxQ1AsSUFBckMsRUFBMkM7QUFDdkM7O0FBRUEsYUFB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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBlc2NhcGVSZWdFeHAgYXMgZXNjYXBlUmUgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGNvcnJlY3RGaWxlUGF0aCBmcm9tICcuLi91dGlscy9jb3JyZWN0LWZpbGUtcGF0aCc7XG5pbXBvcnQgZXNjYXBlVXNlckFnZW50IGZyb20gJy4uL3V0aWxzL2VzY2FwZS11c2VyLWFnZW50JztcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcblxuY29uc3QgREFURV9GT1JNQVQgPSAnWVlZWS1NTS1ERCc7XG5jb25zdCBUSU1FX0ZPUk1BVCA9ICdISC1tbS1zcyc7XG5cbmNvbnN0IEVSUk9SU19GT0xERVIgPSAnZXJyb3JzJztcblxuY29uc3QgUFJPQkxFTUFUSUNfUExBQ0VIT0xERVJfVkFMVUUgPSAnJztcblxuY29uc3QgUExBQ0VIT0xERVJTID0ge1xuICAgIERBVEU6ICAgICAgICAgICAgICAgJyR7REFURX0nLFxuICAgIFRJTUU6ICAgICAgICAgICAgICAgJyR7VElNRX0nLFxuICAgIFRFU1RfSU5ERVg6ICAgICAgICAgJyR7VEVTVF9JTkRFWH0nLFxuICAgIEZJTEVfSU5ERVg6ICAgICAgICAgJyR7RklMRV9JTkRFWH0nLFxuICAgIFFVQVJBTlRJTkVfQVRURU1QVDogJyR7UVVBUkFOVElORV9BVFRFTVBUfScsXG4gICAgRklYVFVSRTogICAgICAgICAgICAnJHtGSVhUVVJFfScsXG4gICAgVEVTVDogICAgICAgICAgICAgICAnJHtURVNUfScsXG4gICAgVVNFUkFHRU5UOiAgICAgICAgICAnJHtVU0VSQUdFTlR9JyxcbiAgICBCUk9XU0VSOiAgICAgICAgICAgICcke0JST1dTRVJ9JyxcbiAgICBCUk9XU0VSX1ZFUlNJT046ICAgICcke0JST1dTRVJfVkVSU0lPTn0nLFxuICAgIE9TOiAgICAgICAgICAgICAgICAgJyR7T1N9JyxcbiAgICBPU19WRVJTSU9OOiAgICAgICAgICcke09TX1ZFUlNJT059JyxcbiAgICBURVNUX0lEOiAgICAgICAgICAgICcke1RFU1RfSUR9JyxcbiAgICBSVU5fSUQ6ICAgICAgICAgICAgICcke1JVTl9JRH0nXG59O1xuXG5jb25zdCBERUZBVUxUX1BBVEhfUEFUVEVSTl9GT1JfUkVQT1JUID0gYCR7UExBQ0VIT0xERVJTLkRBVEV9XyR7UExBQ0VIT0xERVJTLlRJTUV9XFxcXCR7UExBQ0VIT0xERVJTLlRFU1RfSUR9XFxcXGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGAke1BMQUNFSE9MREVSUy5SVU5fSUR9XFxcXCR7UExBQ0VIT0xERVJTLlVTRVJBR0VOVH1cXFxcJHtQTEFDRUhPTERFUlMuRklMRV9JTkRFWH1gO1xuXG5jb25zdCBURVNUX0lEX1RFTVBMQVRFID0gZGF0YSA9PiBkYXRhLnRlc3RJbmRleCA/IGB0ZXN0LSR7ZGF0YS50ZXN0SW5kZXh9YCA6ICcnO1xuY29uc3QgUlVOX0lEX1RFTVBMQVRFICA9IGRhdGEgPT4gZGF0YS5xdWFyYW50aW5lQXR0ZW1wdCA/IGBydW4tJHtkYXRhLnF1YXJhbnRpbmVBdHRlbXB0fWAgOiAnJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGF0aFBhdHRlcm4gZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yIChwYXR0ZXJuLCBmaWxlRXh0ZW5zaW9uLCBkYXRhKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5wYXR0ZXJuICAgICAgICAgICAgICA9IHRoaXMuX2Vuc3VyZVBhdHRlcm4ocGF0dGVybik7XG4gICAgICAgIHRoaXMuZGF0YSAgICAgICAgICAgICAgICAgPSB0aGlzLl9hZGREZWZhdWx0RmllbGRzKGRhdGEpO1xuICAgICAgICB0aGlzLnBsYWNlaG9sZGVyVG9EYXRhTWFwID0gdGhpcy5fY3JlYXRlUGxhY2Vob2xkZXJUb0RhdGFNYXAoKTtcbiAgICAgICAgdGhpcy5maWxlRXh0ZW5zaW9uICAgICAgICA9IGZpbGVFeHRlbnNpb247XG4gICAgfVxuXG4gICAgX2Vuc3VyZVBhdHRlcm4gKHBhdHRlcm4pIHtcbiAgICAgICAgaWYgKHBhdHRlcm4pXG4gICAgICAgICAgICByZXR1cm4gcGF0dGVybjtcblxuICAgICAgICByZXR1cm4gREVGQVVMVF9QQVRIX1BBVFRFUk5fRk9SX1JFUE9SVDtcbiAgICB9XG5cbiAgICBfYWRkRGVmYXVsdEZpZWxkcyAoZGF0YSkge1xuICAgICAgICBjb25zdCBkZWZhdWx0RmllbGRzID0ge1xuICAgICAgICAgICAgdGVzdElkOiAgICAgICAgIFRFU1RfSURfVEVNUExBVEUoZGF0YSksXG4gICAgICAgICAgICBydW5JZDogICAgICAgICAgUlVOX0lEX1RFTVBMQVRFKGRhdGEpLFxuICAgICAgICAgICAgZm9ybWF0dGVkRGF0ZTogIGRhdGEubm93LmZvcm1hdChEQVRFX0ZPUk1BVCksXG4gICAgICAgICAgICBmb3JtYXR0ZWRUaW1lOiAgZGF0YS5ub3cuZm9ybWF0KFRJTUVfRk9STUFUKSxcbiAgICAgICAgICAgIGZpbGVJbmRleDogICAgICAxLFxuICAgICAgICAgICAgZXJyb3JGaWxlSW5kZXg6IDFcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdEZpZWxkcywgZGF0YSk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVBsYWNlaG9sZGVyVG9EYXRhTWFwICgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVEVTVF9JRF06ICAgICAgICAgICAgdGhpcy5kYXRhLnRlc3RJZCxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuUlVOX0lEXTogICAgICAgICAgICAgdGhpcy5kYXRhLnJ1bklkLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5EQVRFXTogICAgICAgICAgICAgICB0aGlzLmRhdGEuZm9ybWF0dGVkRGF0ZSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVElNRV06ICAgICAgICAgICAgICAgdGhpcy5kYXRhLmZvcm1hdHRlZFRpbWUsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlRFU1RfSU5ERVhdOiAgICAgICAgIHRoaXMuZGF0YS50ZXN0SW5kZXgsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlFVQVJBTlRJTkVfQVRURU1QVF06IHRoaXMuZGF0YS5xdWFyYW50aW5lQXR0ZW1wdCB8fCAxLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5GSVhUVVJFXTogICAgICAgICAgICB0aGlzLmRhdGEuZml4dHVyZSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVEVTVF06ICAgICAgICAgICAgICAgdGhpcy5kYXRhLnRlc3QsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLkZJTEVfSU5ERVhdOiAgICAgICAgIGZvckVycm9yID0+IGZvckVycm9yID8gdGhpcy5kYXRhLmVycm9yRmlsZUluZGV4IDogdGhpcy5kYXRhLmZpbGVJbmRleCxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuVVNFUkFHRU5UXTogICAgICAgICAgdGhpcy5kYXRhLnBhcnNlZFVzZXJBZ2VudC50b1N0cmluZygpLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5CUk9XU0VSXTogICAgICAgICAgICB0aGlzLmRhdGEucGFyc2VkVXNlckFnZW50LmZhbWlseSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuQlJPV1NFUl9WRVJTSU9OXTogICAgdGhpcy5kYXRhLnBhcnNlZFVzZXJBZ2VudC50b1ZlcnNpb24oKSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuT1NdOiAgICAgICAgICAgICAgICAgdGhpcy5kYXRhLnBhcnNlZFVzZXJBZ2VudC5vcy5mYW1pbHksXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLk9TX1ZFUlNJT05dOiAgICAgICAgIHRoaXMuZGF0YS5wYXJzZWRVc2VyQWdlbnQub3MudG9WZXJzaW9uKClcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfYnVpbGRQYXRoIChwYXR0ZXJuLCBwbGFjZWhvbGRlclRvRGF0YU1hcCwgZm9yRXJyb3IpIHtcbiAgICAgICAgbGV0IHJlc3VsdEZpbGVQYXRoICAgICAgICAgICAgPSBwYXR0ZXJuO1xuICAgICAgICBjb25zdCBwcm9ibGVtYXRpY1BsYWNlaG9sZGVycyA9IFtdO1xuXG4gICAgICAgIGZvciAoY29uc3QgcGxhY2Vob2xkZXIgaW4gcGxhY2Vob2xkZXJUb0RhdGFNYXApIHtcbiAgICAgICAgICAgIGNvbnN0IGZpbmRQbGFjZWhvbGRlclJlZ0V4cCA9IG5ldyBSZWdFeHAoZXNjYXBlUmUocGxhY2Vob2xkZXIpLCAnZycpO1xuXG4gICAgICAgICAgICByZXN1bHRGaWxlUGF0aCA9IHJlc3VsdEZpbGVQYXRoLnJlcGxhY2UoZmluZFBsYWNlaG9sZGVyUmVnRXhwLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHBsYWNlaG9sZGVyID09PSBQTEFDRUhPTERFUlMuRklMRV9JTkRFWCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBnZXRGaWxlSW5kZXhGbiA9IHBsYWNlaG9sZGVyVG9EYXRhTWFwW3BsYWNlaG9sZGVyXTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdCAgICAgICAgICAgPSBnZXRGaWxlSW5kZXhGbihmb3JFcnJvcik7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvckVycm9yKVxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gYCR7RVJST1JTX0ZPTERFUn1cXFxcJHtyZXN1bHR9YDtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHBsYWNlaG9sZGVyID09PSBQTEFDRUhPTERFUlMuVVNFUkFHRU5UKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJBZ2VudCA9IHBsYWNlaG9sZGVyVG9EYXRhTWFwW3BsYWNlaG9sZGVyXTtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXNjYXBlVXNlckFnZW50KHVzZXJBZ2VudCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgbGV0IGNhbGN1bGF0ZWRWYWx1ZSA9IHBsYWNlaG9sZGVyVG9EYXRhTWFwW3BsYWNlaG9sZGVyXTtcblxuICAgICAgICAgICAgICAgIGlmIChjYWxjdWxhdGVkVmFsdWUgPT09IG51bGwgfHwgY2FsY3VsYXRlZFZhbHVlID09PSB2b2lkIDApIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvYmxlbWF0aWNQbGFjZWhvbGRlcnMucHVzaChwbGFjZWhvbGRlcik7XG5cbiAgICAgICAgICAgICAgICAgICAgY2FsY3VsYXRlZFZhbHVlID0gUFJPQkxFTUFUSUNfUExBQ0VIT0xERVJfVkFMVUU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNhbGN1bGF0ZWRWYWx1ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHByb2JsZW1hdGljUGxhY2Vob2xkZXJzLmxlbmd0aClcbiAgICAgICAgICAgIHRoaXMuZW1pdCgncHJvYmxlbWF0aWMtcGxhY2Vob2xkZXJzLWZvdW5kJywgeyBwbGFjZWhvbGRlcnM6IHByb2JsZW1hdGljUGxhY2Vob2xkZXJzIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHRGaWxlUGF0aDtcbiAgICB9XG5cbiAgICBnZXRQYXRoIChmb3JFcnJvcikge1xuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5fYnVpbGRQYXRoKHRoaXMucGF0dGVybiwgdGhpcy5wbGFjZWhvbGRlclRvRGF0YU1hcCwgZm9yRXJyb3IpO1xuXG4gICAgICAgIHJldHVybiBjb3JyZWN0RmlsZVBhdGgocGF0aCwgdGhpcy5maWxlRXh0ZW5zaW9uKTtcbiAgICB9XG5cbiAgICAvLyBGb3IgdGVzdGluZyBwdXJwb3Nlc1xuICAgIHN0YXRpYyBnZXQgUExBQ0VIT0xERVJTICgpIHtcbiAgICAgICAgcmV0dXJuIFBMQUNFSE9MREVSUztcbiAgICB9XG59XG4iXX0=
